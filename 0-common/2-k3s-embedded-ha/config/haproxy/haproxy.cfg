global
    log /dev/log  local0 warning
    chroot      /var/lib/haproxy
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

   stats socket /var/lib/haproxy/stats

defaults
    log global
    option  httplog
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend k8s-api
    mode tcp
    bind *:8443
    default_backend k8s-api

frontend k8s-ingress-http
    mode tcp
    bind *:80
    default_backend k8s-ingress-http

frontend k8s-ingress-https
    mode tcp
    bind *:443
    default_backend k8s-ingress-https


backend k8s-api
    mode tcp
    option tcp-check
    balance roundrobin
    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
    server control-plane-0 192.168.168.111:6443 check
    server control-plane-1 192.168.168.112:6443 check
    server control-plane-2 192.168.168.113:6443 check

backend k8s-ingress-http
    mode tcp
    option tcp-check
    option forwardfor
    balance roundrobin
    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
    server control-plane-0 192.168.168.111:30080 check send-proxy-v2
    server control-plane-1 192.168.168.112:30080 check send-proxy-v2
    server control-plane-2 192.168.168.113:30080 check send-proxy-v2

backend k8s-ingress-https
    mode tcp
    option tcp-check
    option forwardfor
    balance roundrobin
    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
    server control-plane-0 192.168.168.111:30443 check send-proxy-v2
    server control-plane-1 192.168.168.112:30443 check send-proxy-v2
    server control-plane-2 192.168.168.113:30443 check send-proxy-v2